<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Card Manager PRO</title>
    <style>
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1f2933;
            --muted: #6b7280;
            --primary: #1f535c;
            --accent: #e5eef0;
            --danger: #c0392b;
            --success: #27ae60;
            --border: #d1d5db;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .container {
            padding: 20px;
            padding-bottom: 160px; /* Large space for fixed footer */
            max-width: 950px;
            margin: auto;
        }

        /* SECTIONS */
        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section.locked { opacity: 0.7; pointer-events: none; }

        h2 {
            font-size: 16px;
            margin: 0 0 16px 0;
            color: var(--primary);
            border-bottom: 1px solid var(--accent);
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* GRIDS */
        .grid-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .info-item small {
            color: var(--muted);
            display: block;
            text-transform: uppercase;
            font-size: 10px;
            font-weight: bold;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        /* INPUTS */
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 14px;
        }

        textarea { resize: none; min-height: 80px; }

        /* BUTTONS */
        button {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .primary { background: var(--primary); color: #fff; }
        .secondary { background: #e5e7eb; color: var(--text); }
        .danger-link { color: var(--danger); background: none; width: auto; font-size: 12px; text-decoration: underline; padding: 0; }
        .success-btn { background: var(--success); color: #fff; }

        /* TASK CARD */
        .task-card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary);
            position: relative;
        }

        .history-card { border-top-color: var(--success); background: #f9fffb; }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ref-block {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .file-label {
            display: block;
            margin-top: 8px;
            font-size: 11px;
            color: var(--primary);
            font-weight: bold;
        }

        /* FIXED ACTIONS FOOTER */
        .fixed-actions {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--card);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .mh-total-badge {
            background: var(--accent);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            white-space: nowrap;
        }

        /* MOBILE FIXES */
        @media (max-width: 600px) {
            .fixed-actions {
                grid-template-columns: 1fr 1fr;
                padding: 10px;
            }
            .mh-total-badge { grid-column: span 2; order: -1; }
            .container { padding-bottom: 200px; }
        }

        .confirm-overlay {
            position: fixed; inset: 0;
            background: rgba(31,83,92,0.98);
            display: none; align-items: center; justify-content: center;
            color: #fff; flex-direction: column; z-index: 2000;
            text-align: center; padding: 20px;
        }

        .finding-content img {
            width: 100%; max-height: 300px; object-fit: contain;
            border-radius: 8px; background: #eee; margin: 10px 0;
        }

        .collapsed { display: none; }
    </style>
</head>
<body oninput="saveDraft()">

<div class="container">
    <!-- Header Info -->
    <div class="section" id="infoSection">
        <h2>General Information</h2>
        <div class="grid-info" id="infoGrid">
            <div class="info-item"><small>Status</small>Loading...</div>
        </div>
    </div>

    <!-- Finding Selection -->
    <div class="section" id="findingSection">
        <h2>Finding Selection</h2>
        <select id="findingSelect" onchange="handleFindingChange(this)">
            <option value="">Connecting to Sheet...</option>
        </select>

        <div id="findingContent" class="collapsed">
            <img src="" id="fimg">
            <div class="row">
                <div><small>Identification</small><p id="fid" style="font-weight:600">-</p></div>
                <div><small>Action Given</small><p id="faction" style="font-weight:600">-</p></div>
            </div>
        </div>
    </div>

    <!-- History -->
    <div id="historySection" class="collapsed">
        <h2 style="color:var(--success)">Existing Task Cards (Submitted)</h2>
        <div id="historyContainer"></div>
    </div>

    <!-- Creation Zone -->
    <div id="startZone" style="text-align:center; padding: 30px;">
        <button class="primary" onclick="startWork()" style="width: 250px;">+ Create New Task Cards</button>
    </div>

    <div id="taskWorkspace" class="collapsed">
        <div id="taskContainer"></div>
        <button class="secondary" onclick="addTask()" style="width:100%">+ Add New Task Card</button>
    </div>
</div>

<!-- Sticky Footer -->
<div class="fixed-actions">
    <button class="secondary" onclick="resetForm()">Reset</button>
    <div class="mh-total-badge">Total: <span id="totalMH">0.0</span> MH</div>
    <button class="primary" id="submitBtn" onclick="submitWork()">Submit All Cards</button>
</div>

<!-- Success Overlay -->
<div class="confirm-overlay" id="confirmBox">
    <h1 id="resMsg">Success!</h1>
    <p>Data has been synced to the database.</p>
    <button class="secondary" onclick="location.reload()" style="margin-top:20px">Create New Session</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxVryoi5YzLOR-0AfgH458bfO6b5LP-ffBdGNAYILLQEfQC5U8gCLmRfCmZwCLukShbyg/exec";
    
    let FINDINGS_DATA = [];
    let CURRENT_WO = "";

    // 1. INITIAL LOAD
    window.onload = async () => {
        try {
            const resp = await fetch(`${API_URL}?action=getInitialData`);
            const data = await resp.json();
            
            FINDINGS_DATA = data.findings;
            CURRENT_WO = data.info.woNo;

            document.getElementById("infoGrid").innerHTML = `
                <div class="info-item"><small>W/O No.</small>${data.info.woNo}</div>
                <div class="info-item"><small>Customer</small>${data.info.customer}</div>
                <div class="info-item"><small>A/C Reg</small>${data.info.acReg}</div>
                <div class="info-item"><small>P/N</small>${data.info.pn}</div>
            `;

            const select = document.getElementById("findingSelect");
            select.innerHTML = '<option value="">Select Finding No.</option>';
            data.findings.forEach(f => {
                select.innerHTML += `<option value="${f.no}">${f.no} - ${f.identification.substring(0,30)}...</option>`;
            });

            loadDraft();
        } catch (e) {
            alert("Error: Could not connect to Google Sheets.");
        }
    };

    // 2. CORE LOGIC
    function handleFindingChange(el) {
        const finding = FINDINGS_DATA.find(f => f.no == el.value);
        if(!finding) return;

        document.getElementById("fid").innerText = finding.identification;
        document.getElementById("faction").innerText = finding.action;
        document.getElementById("fimg").src = finding.pic;
        document.getElementById("findingContent").classList.remove("collapsed");

        loadHistory(el.value);
    }

    async function loadHistory(fNo) {
        const container = document.getElementById("historyContainer");
        const section = document.getElementById("historySection");
        container.innerHTML = "Loading history...";
        section.classList.remove("collapsed");

        try {
            const resp = await fetch(`${API_URL}?action=getExistingTasks&findingNo=${fNo}`);
            const tasks = await resp.json();

            if (tasks.length === 0) {
                section.classList.add("collapsed");
                return;
            }

            container.innerHTML = "";
            tasks.forEach(t => {
                const div = document.createElement("div");
                div.className = "task-card history-card";
                
                let refsHtml = t.references.map(r => `
                    <div style="font-size:12px; margin-top:5px; padding:5px; background:#fff; border-radius:4px; display:flex; justify-content:space-between;">
                        <span><b>${r.docType}:</b> ${r.title}</span>
                        <a href="${r.link}" target="_blank" style="color:var(--primary)">View ðŸ“‚</a>
                    </div>
                `).join("");

                div.innerHTML = `
                    <div class="task-header">
                        <b>${t.taskNo} | ${t.type}</b>
                        <span class="mh-total-badge">${t.mh} MH</span>
                    </div>
                    <p style="font-size:13px; margin:10px 0;">${t.description}</p>
                    <div style="background:var(--accent); padding:10px; border-radius:8px;">
                        <small><b>REFERENCES:</b></small>${refsHtml || '<br>None'}
                    </div>
                `;
                container.appendChild(div);
            });
        } catch (e) { container.innerHTML = "Failed to load history."; }
    }

    function addTask(data = null) {
        const card = document.createElement("div");
        card.className = "task-card";
        card.innerHTML = `
            <div class="task-header">
                <span class="task-no-label">TASK T0000</span>
                <div style="display:flex; gap:10px;">
                    <button class="secondary" style="font-size:11px; padding:5px 10px;" onclick="duplicateCard(this)">Duplicate</button>
                    <button class="danger-link" onclick="removeCard(this)">Remove</button>
                </div>
            </div>
            <div class="row">
                <select><option>Structure</option><option>Cabin</option><option>Special Process</option></select>
                <select><option>Inspection</option><option>Remove / Install</option><option>Repair</option><option>General</option></select>
                <input type="number" step="0.1" placeholder="MH" class="mh-input" oninput="calculateTotalMH()">
            </div>
            <textarea placeholder="Work Description..." oninput="autoResize(this)"></textarea>
            
            <div class="ref-list"></div>
            <button class="secondary" style="width:auto; font-size:12px; padding:5px 15px;" onclick="addRef(this)">+ Add Reference</button>
            
            <div class="notes-section" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <textarea placeholder="Internal Notes (Optional)" style="font-size:12px; min-height:40px;"></textarea>
            </div>
        `;
        document.getElementById("taskContainer").appendChild(card);
        
        if(data) fillCardData(card, data);
        updateNumbers();
    }

    function fillCardData(card, data) {
        const selects = card.querySelectorAll("select");
        selects[0].value = data.cat;
        selects[1].value = data.type;
        card.querySelector(".mh-input").value = data.mh;
        const textareas = card.querySelectorAll("textarea");
        textareas[0].value = data.desc;
        textareas[1].value = data.note;
        if(data.refs) data.refs.forEach(r => addRef(card.querySelector("button"), r));
    }

    function addRef(btn, data = null) {
        const list = btn.previousElementSibling;
        const div = document.createElement("div");
        div.className = "ref-block";
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between">
                <small class="ref-label">Reference R01</small>
                <button class="danger-link" onclick="this.parentElement.parentElement.remove(); updateNumbers();">Remove</button>
            </div>
            <div class="row">
                <select><option>AMM</option><option>CMM</option><option>SRM</option></select>
                <input placeholder="Chapter / Title">
            </div>
            <div class="row">
                <input placeholder="Rev">
                <input type="date">
            </div>
            <input type="file" onchange="updateFileName(this)" style="font-size:11px; border:none; padding:0;">
            <span class="file-label"></span>
        `;
        list.appendChild(div);
        if(data) {
            div.querySelector("select").value = data.docType;
            const ins = div.querySelectorAll("input");
            ins[0].value = data.title; ins[1].value = data.rev; ins[2].value = data.date;
        }
        updateNumbers();
    }

    function updateFileName(input) {
        const label = input.nextElementSibling;
        label.innerText = input.files[0] ? "Attached: " + input.files[0].name : "";
    }

    function calculateTotalMH() {
        let total = 0;
        document.querySelectorAll(".mh-input").forEach(i => total += parseFloat(i.value || 0));
        document.getElementById("totalMH").innerText = total.toFixed(1);
    }

    function updateNumbers() {
        document.querySelectorAll(".task-card").forEach((c, i) => {
            c.querySelector(".task-no-label").innerText = "TASK T" + String((i+1)*10).padStart(4, '0');
            c.querySelectorAll(".ref-label").forEach((r, ri) => {
                r.innerText = "Reference R" + String(ri+1).padStart(2, '0');
            });
        });
        calculateTotalMH();
    }

    function duplicateCard(btn) {
        const card = btn.closest(".task-card");
        const data = {
            cat: card.querySelectorAll("select")[0].value,
            type: card.querySelectorAll("select")[1].value,
            mh: card.querySelector(".mh-input").value,
            desc: card.querySelectorAll("textarea")[0].value,
            note: card.querySelectorAll("textarea")[1].value,
            refs: Array.from(card.querySelectorAll(".ref-block")).map(r => ({
                docType: r.querySelector("select").value,
                title: r.querySelectorAll("input")[0].value,
                rev: r.querySelectorAll("input")[1].value,
                date: r.querySelectorAll("input")[2].value
            }))
        };
        addTask(data);
    }

    // 3. STORAGE & SUBMISSION
    function saveDraft() {
        const draft = {
            fNo: document.getElementById("findingSelect").value,
            tasks: Array.from(document.querySelectorAll(".task-card")).map(c => ({
                cat: c.querySelectorAll("select")[0].value,
                type: c.querySelectorAll("select")[1].value,
                mh: c.querySelector(".mh-input").value,
                desc: c.querySelectorAll("textarea")[0].value,
                note: c.querySelectorAll("textarea")[1].value,
                refs: Array.from(c.querySelectorAll(".ref-block")).map(r => ({
                    docType: r.querySelector("select").value,
                    title: r.querySelectorAll("input")[0].value,
                    rev: r.querySelectorAll("input")[1].value,
                    date: r.querySelectorAll("input")[2].value
                }))
            }))
        };
        localStorage.setItem("tc_draft", JSON.stringify(draft));
    }

    function loadDraft() {
        const saved = localStorage.getItem("tc_draft");
        if(!saved) return;
        const draft = JSON.parse(saved);
        if(draft.fNo) {
            document.getElementById("findingSelect").value = draft.fNo;
            handleFindingChange(document.getElementById("findingSelect"));
            if(draft.tasks.length > 0) {
                startWork();
                document.getElementById("taskContainer").innerHTML = "";
                draft.tasks.forEach(t => addTask(t));
            }
        }
    }

    async function submitWork() {
        const fNo = document.getElementById("findingSelect").value;
        if(!fNo) return alert("Validation Error: Please select a Finding No.");

        const cards = document.querySelectorAll(".task-card");
        if(cards.length === 0) return alert("Add at least one task card.");

        const payloadTasks = [];
        for (let card of cards) {
            const desc = card.querySelectorAll("textarea")[0].value;
            const mh = card.querySelector(".mh-input").value;
            if(!desc || !mh) return alert("Validation Error: Description and Man-Hours are required.");

            const refs = [];
            for (let rb of card.querySelectorAll(".ref-block")) {
                const fileIn = rb.querySelector('input[type="file"]');
                let fileData = null;
                if(fileIn.files[0]) {
                    fileData = { 
                        name: fileIn.files[0].name, 
                        mimeType: fileIn.files[0].type, 
                        base64: await toBase64(fileIn.files[0]) 
                    };
                }
                refs.push({
                    docType: rb.querySelector("select").value,
                    title: rb.querySelectorAll("input")[0].value,
                    rev: rb.querySelectorAll("input")[1].value,
                    date: rb.querySelectorAll("input")[2].value,
                    fileData: fileData
                });
            }

            payloadTasks.push({
                findingNo: fNo,
                category: card.querySelectorAll("select")[0].value,
                type: card.querySelectorAll("select")[1].value,
                mh: mh,
                description: desc,
                notes: card.querySelectorAll("textarea")[1].value,
                references: refs
            });
        }

        // START UPLOAD
        const btn = document.getElementById("submitBtn");
        btn.disabled = true; btn.innerText = "Uploading...";

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "saveTaskCards", wo: CURRENT_WO, tasks: payloadTasks })
            });
            const result = await response.json();
            
            if(result.status === "success") {
                localStorage.removeItem("tc_draft");
                document.getElementById("confirmBox").style.display = "flex";
            } else {
                throw new Error(result.message);
            }
        } catch (e) {
            alert("Submission error. Check your connection.");
            btn.disabled = false; btn.innerText = "Submit All Cards";
        }
    }

    // UTILS
    const toBase64 = file => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => res(reader.result.split(',')[1]);
        reader.onerror = e => rej(e);
    });

    function autoResize(t) { t.style.height = "auto"; t.style.height = t.scrollHeight + "px"; }
    function startWork() {
        if(!document.getElementById("findingSelect").value) return alert("Select a finding first.");
        document.getElementById("startZone").style.display = "none";
        document.getElementById("taskWorkspace").classList.remove("collapsed");
        document.getElementById("infoSection").classList.add("locked");
        document.getElementById("findingSection").classList.add("locked");
        if(document.getElementById("taskContainer").children.length === 0) addTask();
    }
    function removeCard(btn) { if(confirm("Delete task?")) { btn.closest(".task-card").remove(); updateNumbers(); }}
    function resetForm() { if(confirm("Clear all data?")) { localStorage.removeItem("tc_draft"); location.reload(); }}
</script>

</body>
</html>
