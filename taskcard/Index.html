<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Card Creator</title>
<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --text:#1f2933;
  --muted:#6b7280;
  --primary:#1f535c;
  --accent:#e5eef0;
  --danger:#c0392b;
  --success:#27ae60;
  --border:#d1d5db;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height: 1.5;
}
.container{
  padding:20px;
  padding-bottom:120px;
  max-width:900px;
  margin:auto;
}

/* SECTIONS */
.section{
  background:var(--card);
  border-radius:12px;
  padding:24px;
  margin-bottom:20px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.section.locked{ opacity:.7; }

.info-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:16px;
}
.info-item small{
  color:var(--muted);
  display:block;
  margin-bottom:4px;
  text-transform: uppercase;
  font-size: 11px;
}
h2{
  font-size:16px;
  margin:0 0 16px 0;
  color: var(--primary);
  border-bottom: 1px solid var(--accent);
  padding-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* INPUTS & BUTTONS */
select,input,textarea,button{
  width:100%;
  font-family:inherit;
  font-size:14px;
}
select,input,textarea{
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background: #fff;
  transition: background 0.2s;
}
/* Locked State Visuals */
.is-locked select, .is-locked input, .is-locked textarea {
    background: #f8fafc;
    border-color: transparent;
    pointer-events: none;
    color: #475569;
}

textarea{ resize:none; min-height:90px; margin-bottom: 16px; }

button{
  padding:12px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor: pointer;
}
.primary{ background:var(--primary); color:#fff; }
.secondary{ background:#e5e7eb; color: var(--text); }
.success-btn{ background:var(--success); color:#fff; }

/* TASK CARD DESIGN */
.task-card{
  background: var(--card);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 30px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  border-top: 4px solid var(--primary);
  position: relative;
}
.task-header{
  font-weight:800;
  margin-bottom:20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--primary);
}
.header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}
.remove-link {
  color: var(--danger);
  font-size: 12px;
  background: none;
  width: auto;
  padding: 0;
  text-decoration: underline;
}
.edit-btn {
    width: auto;
    padding: 6px 15px;
    font-size: 12px;
}

.row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:12px;
  margin-bottom:12px;
}

/* REFERENCE BLOCK */
.ref-block{
  background: #f9fafb;
  border:1px solid var(--border);
  border-radius:10px;
  padding:16px;
  margin-top: 15px;
  margin-bottom:15px; 
}
.ref-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  color: var(--primary);
  font-size: 13px;
}

.notes { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--accent); }
.notes.collapsed textarea { display:none; }

.finding-content.collapsed { display: none; }
.finding-content img {
  width: 100%;
  max-height: 250px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 16px;
}

.fixed-actions{
  position:fixed; bottom:0; left:0; right:0;
  background:var(--card);
  box-shadow:0 -4px 12px rgba(0,0,0,.1);
  padding:20px;
  display:flex;
  gap:12px;
  z-index: 100;
}
.confirm{
  position:fixed; inset:0;
  background:rgba(31,83,92,.95);
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-size:18px; display:none; z-index: 1000;
}
</style>
</head>
<body>

<div class="container">
  <!-- General Info -->
  <div class="section" id="info">
    <h2>General Information</h2>
    <div class="info-grid">
      <div class="info-item"><small>W/O No.</small>WO-2026-0147</div>
      <div class="info-item"><small>Customer</small>Garuda Indonesia</div>
      <div class="info-item"><small>A/C Registration</small>PK-GMF</div>
      <div class="info-item"><small>Part Description</small>Aft Pressure Bulkhead</div>
      <div class="info-item"><small>Part Number</small>65-43210-001</div>
      <div class="info-item"><small>Serial Number</small>SN-APB-7789</div>
    </div>
  </div>

  <!-- Finding Section -->
  <div class="section" id="finding">
    <h2>
        Finding Selection
        <button onclick="toggleFindingDetails()" id="toggleFinding" style="display:none; background:none; color:var(--primary); font-size:12px; width:auto; text-decoration:underline;">Collapse Details</button>
    </h2>
    <select id="findingSelect" onchange="handleFindingChange(this)">
      <option value="">Select Finding No.</option>
      <option value="F001">F001 – Corrosion</option>
      <option value="F002">F002 – Crack Indication</option>
      <option value="F003">F003 – Sealant Degradation</option>
    </select>

    <div class="finding-content collapsed" id="findingContent">
        <img src="https://via.placeholder.com/800x300?text=Finding+Photo" id="fimg" style="margin-top:15px">
        <div class="row">
            <div>
                <small>Identification</small>
                <p style="font-weight:600" id="fid">-</p>
            </div>
            <div>
                <small>Action Given</small>
                <p style="font-weight:600" id="faction">-</p>
            </div>
        </div>
    </div>
  </div>

  <div id="startZone" style="text-align:center; padding: 20px;">
    <button class="primary" id="startBtn" onclick="startWork()" style="max-width:300px">Start Creating Task Cards</button>
  </div>

  <div id="tasks" style="display:none">
    <div id="taskContainer"></div>
    <div style="padding: 20px 0;">
        <button class="secondary" onclick="addTask()">+ Add New Task Card</button>
    </div>
  </div>
</div>

<div class="fixed-actions">
  <button class="secondary" onclick="resetForm()">Reset</button>
  <button class="primary" onclick="submitWork()">Submit Work</button>
</div>

<div class="confirm" id="confirmBox">Task Cards Submitted Successfully</div>

<script>
const taskContainer = document.getElementById("taskContainer");
const findingContent = document.getElementById("findingContent");
const toggleFindingBtn = document.getElementById("toggleFinding");

function updateAllNumbers() {
  const cards = taskContainer.querySelectorAll(".task-card");
  cards.forEach((card, cardIndex) => {
    const taskBaseNum = (cardIndex + 1) * 10;
    const taskString = String(taskBaseNum).padStart(4, '0');
    card.querySelector(".task-no-label").innerText = `TASK NO. ${taskString}`;

    const refs = card.querySelectorAll(".ref-block");
    refs.forEach((ref, refIndex) => {
      const refSuffix = String(refIndex + 1).padStart(2, '0');
      ref.querySelector(".ref-no-label").innerText = `Reference ${taskString}${refSuffix}`;
    });
  });
}

function autoResize(t) {
  t.style.height = "auto";
  t.style.height = t.scrollHeight + "px";
}

function toggleEdit(btn, card) {
    const isLocked = card.classList.toggle("is-locked");
    if (isLocked) {
        btn.innerText = "Edit Task";
        btn.className = "edit-btn secondary";
    } else {
        btn.innerText = "Save Task";
        btn.className = "edit-btn success-btn";
    }
}

function addTask() {
  const card = document.createElement("div");
  card.className = "task-card"; // Start in "Edit" mode (not locked)
  card.innerHTML = `
    <div class="task-header">
      <span class="task-no-label">TASK NO. 0000</span>
      <div class="header-actions">
          <button class="edit-btn success-btn" onclick="toggleEdit(this, this.closest('.task-card'))">Save Task</button>
          <button class="remove-link" onclick="removeCard(this.closest('.task-card'))">Remove Card</button>
      </div>
    </div>
    
    <div class="row">
      <select><option>Structure</option><option>Cabin</option><option>Special Process</option></select>
      <select><option>Inspection</option><option>Remove / Install</option><option>Repair</option><option>General</option></select>
      <input type="number" step="0.1" placeholder="Man-hours (MH)">
    </div>

    <textarea placeholder="Describe the task to be performed..." oninput="autoResize(this)"></textarea>

    <div class="references">
      <div class="ref-list"></div>
      <button class="secondary" style="width:auto; padding: 8px 16px; font-size:12px;" onclick="addReference(this)">+ Add Reference</button>
    </div>

    <div class="notes collapsed">
      <button class="secondary" style="width:auto; padding: 8px 16px; font-size:12px; margin-top:12px" onclick="this.parentElement.classList.toggle('collapsed')">+ Add Internal Note</button>
      <textarea placeholder="Optional engineer notes..." style="margin-top:12px" oninput="autoResize(this)"></textarea>
    </div>
  `;

  taskContainer.appendChild(card);
  updateAllNumbers();
}

function removeCard(card) {
    if(confirm("Delete this entire Task Card?")) {
        card.remove();
        updateAllNumbers();
    }
}

function addReference(btn) {
    const refList = btn.previousElementSibling;
    const taskCard = btn.closest('.task-card');
    
    // Don't add reference if card is locked
    if(taskCard.classList.contains('is-locked')) return;

    const ref = document.createElement("div");
    ref.className = "ref-block";
    ref.innerHTML = `
      <div class="ref-header">
        <strong class="ref-no-label">Reference 000000</strong>
        <button class="remove-link" onclick="this.closest('.ref-block').remove(); updateAllNumbers();">Remove</button>
      </div>
      <div class="row">
        <select><option>AMM</option><option>CMM</option><option>SRM</option></select>
        <input placeholder="Task / Chapter Title">
      </div>
      <div class="row">
        <input placeholder="Rev. No.">
        <input type="date">
      </div>
      <input type="file" style="border:none; padding:0; font-size:11px; margin-top:8px;">
    `;
    refList.appendChild(ref);
    updateAllNumbers();
}

// Modify your handleFindingChange to use real data
function handleFindingChange(select) {
    const finding = window.findingData.find(f => f.no == select.value);
    if(!finding) return;
    
    document.getElementById("fid").innerText = finding.identification;
    document.getElementById("faction").innerText = finding.action;
    document.getElementById("fimg").src = finding.pic;
    
    findingContent.classList.remove("collapsed");
    toggleFindingBtn.style.display = "inline";
}

function toggleFindingDetails() {
    const isCollapsed = findingContent.classList.toggle("collapsed");
    toggleFindingBtn.innerText = isCollapsed ? "Show Details" : "Collapse Details";
}

function startWork() {
  if(!document.getElementById("findingSelect").value) {
      alert("Please select a Finding first.");
      return;
  }
  document.getElementById("tasks").style.display = "block";
  document.getElementById("info").classList.add("locked");
  document.getElementById("finding").classList.add("locked");
  findingContent.classList.add("collapsed");
  toggleFindingBtn.innerText = "Show Details";
  document.getElementById("startZone").style.display = "none";
  addTask();
}

function resetForm() {
  if(confirm("Discard all work?")) location.reload();
}

// --- SUBMISSION LOGIC ---

async function submitWork() {
    const tasks = [];
    const wo = "512211519";
    const findingNo = document.getElementById("findingSelect").value;
    
    const cardElements = document.querySelectorAll(".task-card");
    
    for (let card of cardElements) {
        const taskNo = card.querySelector(".task-no-label").innerText.split(" ")[2];
        const refs = [];
        
        // Handle References in this task
        const refBlocks = card.querySelectorAll(".ref-block");
        for (let [index, refBlock] of refBlocks.entries()) {
            const refNo = `R${String(index + 1).padStart(3, '0')}`;
            const fileInput = refBlock.querySelector('input[type="file"]');
            let fileData = null;

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileData = {
                    name: file.name,
                    mimeType: file.type,
                    base64: await toBase64(file)
                };
            }

            refs.push({
                id: findingNo + taskNo + refNo,
                docType: refBlock.querySelectorAll("select")[0].value,
                title: refBlock.querySelectorAll("input")[0].value,
                rev: refBlock.querySelectorAll("input")[1].value,
                date: refBlock.querySelectorAll("input")[2].value,
                fileData: fileData
            });
        }

        tasks.push({
            findingNo: findingNo,
            taskNo: taskNo,
            category: card.querySelectorAll("select")[0].value,
            type: card.querySelectorAll("select")[1].value,
            mh: card.querySelector("input[type='number']").value,
            description: card.querySelector("textarea").value,
            references: refs
        });
    }

    const payload = { action: "saveTaskCards", wo: wo, tasks: tasks };

    google.script.run.withSuccessHandler(() => {
        document.getElementById("confirmBox").style.display = "flex";
        setTimeout(() => location.reload(), 3000);
    }).doPost(payload);
}

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
});

// Initialize on load
window.onload = loadInitialData;
  
</script>

</body>
</html>
